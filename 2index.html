<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background Remover</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-200">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Background Remover</h1>
            <p class="text-gray-600 dark:text-gray-400">Upload an image to automatically remove its background</p>
        </div>

        <!-- Upload Section -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-8">
            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-primary transition-colors duration-200" id="dropZone">
                <div id="uploadContent">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <p class="text-lg text-gray-600 dark:text-gray-400 mb-2">Drop an image here or click to browse</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500">Supports JPG, PNG, WebP formats</p>
                </div>
                <input type="file" id="fileInput" class="hidden" accept="image/*">
            </div>
        </div>

        <!-- Image Preview Section -->
        <div id="imagePreviewSection" class="hidden mb-8">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Original Image</h2>
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                <img id="originalImage" class="max-w-full h-auto mx-auto rounded-lg shadow-md" alt="Original image">
            </div>
            <div class="mt-4 text-center">
                <button id="processButton" class="bg-primary hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 text-base">
                    Remove Background
                </button>
            </div>
        </div>

        <!-- Processing Section -->
        <div id="processingSection" class="hidden mb-8">
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-yellow-600 dark:border-yellow-400 mr-3"></div>
                    <p class="text-yellow-800 dark:text-yellow-200">Processing image... This may take a moment.</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Background Removed</h2>
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mb-4">
                <img id="processedImage" class="max-w-full h-auto mx-auto rounded-lg shadow-md" alt="Processed image">
            </div>
            <div class="text-center">
                <a id="downloadLink" class="inline-block bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 text-base" download>
                    Download Image
                </a>
                <button id="processAnotherButton" class="ml-4 bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 text-base">
                    Process Another
                </button>
            </div>
        </div>

        <!-- Error Section -->
        <div id="errorSection" class="hidden">
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-red-600 dark:text-red-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <p id="errorMessage" class="text-red-800 dark:text-red-200"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // DOM elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const imagePreviewSection = document.getElementById('imagePreviewSection');
        const originalImage = document.getElementById('originalImage');
        const processButton = document.getElementById('processButton');
        const processingSection = document.getElementById('processingSection');
        const resultsSection = document.getElementById('resultsSection');
        const processedImage = document.getElementById('processedImage');
        const downloadLink = document.getElementById('downloadLink');
        const processAnotherButton = document.getElementById('processAnotherButton');
        const errorSection = document.getElementById('errorSection');
        const errorMessage = document.getElementById('errorMessage');

        let currentFile = null;

        // File upload handlers
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-primary');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('File size must be less than 10MB.');
                return;
            }

            currentFile = file;
            hideAllSections();

            // Show image preview
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImage.src = e.target.result;
                imagePreviewSection.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Register handler for background removal
        window.Poe.registerHandler("background-removal-handler", (result, context) => {
            const msg = result.responses[0];

            if (msg.status === "error") {
                processingSection.classList.add('hidden');
                showError("Error processing image: " + (msg.statusText || "Unknown error"));
            } else if (msg.status === "complete") {
                processingSection.classList.add('hidden');
                
                if (msg.attachments && msg.attachments.length > 0) {
                    const imageAttachment = msg.attachments[0];
                    processedImage.src = imageAttachment.url;
                    downloadLink.href = imageAttachment.url;
                    downloadLink.download = imageAttachment.name || 'background-removed.png';
                    resultsSection.classList.remove('hidden');
                } else {
                    showError("No processed image was returned. Please try again.");
                }
            }
            // For incomplete status, keep showing loading state
        });

        // Process button handler
        processButton.addEventListener('click', async () => {
            if (!currentFile) return;

            hideAllSections();
            processingSection.classList.remove('hidden');

            try {
                await window.Poe.sendUserMessage(
                    "@remove-background Remove background from this image",
                    {
                        attachments: [currentFile],
                        handler: "background-removal-handler",
                        stream: false,
                        openChat: false
                    }
                );
            } catch (err) {
                processingSection.classList.add('hidden');
                showError("Error starting background removal: " + err.message);
            }
        });

        // Process another button handler
        processAnotherButton.addEventListener('click', () => {
            currentFile = null;
            fileInput.value = '';
            hideAllSections();
        });

        function hideAllSections() {
            imagePreviewSection.classList.add('hidden');
            processingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            errorSection.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorSection.classList.remove('hidden');
        }
    </script>
</body>
</html>
